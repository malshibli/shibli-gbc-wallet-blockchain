<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SHIBLI GBC Wallet</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>

  <style>
    :root{
      --blue:#2b4f81;
      --blue2:#1d3d66;
      --bg:#f5faff;
      --card:#ffffff;
      --soft:#eef6ff;
      --ok:#1a7e4e;
      --warn:#b45309;
      --bad:#b91c1c;
    }
    body{ font-family: "Segoe UI", system-ui, -apple-system, Arial, sans-serif; background:var(--bg); color:var(--blue); margin:0; }
    header{ background:var(--blue); color:#fff; padding:18px 14px; text-align:center; font-size:20px; font-weight:700; }
    .section{ max-width:900px; margin:18px auto; padding:18px; background:var(--card); border-radius:14px; box-shadow:0 4px 14px rgba(0,0,0,.06); }
    h2{ margin:0 0 10px 0; color:var(--blue); font-size:18px; }
    .icon{ color:var(--blue); margin-right:8px; }
    p{ margin:8px 0; line-height:1.45; }
    ul,ol{ text-align:left; padding-left:20px; margin:8px 0; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; }
    .col{ flex:1; min-width:260px; }
    input, button{
      width:100%;
      padding:11px 12px;
      margin:7px 0;
      border-radius:10px;
      border:1px solid #cdd7e3;
      font-size:15px;
      box-sizing:border-box;
    }
    button{
      background:var(--blue);
      color:#fff;
      border:none;
      cursor:pointer;
      transition:.2s;
      font-weight:700;
    }
    button:hover{ background:var(--blue2); }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      background:var(--soft); color:var(--blue); font-size:13px; font-weight:600;
      word-break:break-all;
    }
    .status{ font-weight:700; }
    .status.ok{ color:var(--ok); }
    .status.warn{ color:var(--warn); }
    .status.bad{ color:var(--bad); }
    .small{ font-size:13px; color:#3b5b87; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px; }
    .notice{
      border:1px dashed #b7c7dd;
      background:#fbfdff;
      padding:12px;
      border-radius:12px;
      margin-top:10px;
    }
    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; }
    .btnRow button{ flex:1; min-width:220px; }
    .linkBtn{ background:#0f172a; }
    .linkBtn:hover{ background:#111c33; }

    /* small helper layout blocks (added without changing your layout) */
    .miniGrid{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .miniGrid .pill{ flex:1; min-width:240px; }
    .divider{ border:none; border-top:1px solid #eef2f8; margin:14px 0; }
  </style>
</head>

<body>
  <header><i class="fas fa-globe"></i> SHIBLI GBC Wallet</header>

  <div class="section">
    <h2><i class="fas fa-leaf icon"></i>Welcome to SHIBLI GBC</h2>
    <p><strong>The First Noble Global Birthright Currency</strong><br />Initiated by Professor Murad Al Shibli.</p>
    <p>
      <i class="fas fa-hand-holding-heart icon"></i>Dignity-based universal income<br />
      <i class="fas fa-globe icon"></i>Equal global entitlement<br />
      <i class="fas fa-users icon"></i>Empowerment for all humanity
    </p>

    <div class="notice" id="web3Notice" style="display:none;">
      <div class="pill"><i class="fa-solid fa-triangle-exclamation"></i> MetaMask / Web3 not detected</div>
      <p class="small" style="margin-top:10px;">
        On <b>Android</b>, MetaMask works best inside the <b>MetaMask in-app Browser</b>.
      </p>
      <div class="btnRow">
        <button class="linkBtn" onclick="copyLink()">ðŸ“‹ Copy this page link</button>
        <button onclick="openInMetaMask()">ðŸ¦Š Open in MetaMask Browser</button>
      </div>
      <p class="small" style="margin-top:10px;">
        Steps: Open MetaMask â†’ <b>Browser</b> tab â†’ paste the link â†’ open â†’ then click <b>Connect MetaMask</b>.
      </p>
    </div>
  </div>

  <div class="section">
    <h2><i class="fas fa-bullseye icon"></i>SHIBLI GBC Goals</h2>
    <ul>
      <li><i class="fas fa-balance-scale icon"></i>Equality Beyond Borders</li>
      <li><i class="fas fa-handshake icon"></i>Universal Financial Access</li>
      <li><i class="fas fa-leaf icon"></i>Sustainable Economic Participation</li>
    </ul>
  </div>

  <div class="section">
    <h2><i class="fas fa-gift icon"></i>Your Birthright Share</h2>
    <p><strong>100 GBC â‰ˆ $10,131 USD</strong><br/>This is your global dignity cap entitlement</p>
  </div>

  <div class="section">
    <h2><i class="fas fa-user-check icon"></i>Request GBC</h2>
    <form action="https://formsubmit.co/imurad2009@gmail.com" method="POST" enctype="multipart/form-data">
      <input type="hidden" name="_subject" value="New GBC Request Submitted" />
      <input type="hidden" name="_captcha" value="false" />
      <input type="hidden" name="_template" value="box" />

      <div class="row">
        <div class="col">
          <input type="text" name="Full Name" placeholder="Full Name" required />
          <input type="text" name="National ID / Passport No" placeholder="National ID or Passport No." required />
          <input type="text" name="MetaMask Wallet Address" placeholder="Your MetaMask Wallet Address" required />
          <input type="number" name="Requested Amount (Max 100)" step="1" max="100" placeholder="Enter amount (Max: 100)" required />
        </div>
        <div class="col">
          <label class="small">Upload ID Document:</label>
          <input type="file" name="ID Document" accept=".jpg,.jpeg,.png,.pdf" required />
          <label class="small">Upload Face Photo:</label>
          <input type="file" name="Face Photo" accept="image/*" required />

          <label class="small" style="display:block; margin-top:6px;">
            <input type="checkbox" id="claimingMinor" onchange="toggleMinorFields()" />
            I am claiming on behalf of a child/minor
          </label>

          <div id="minorSection" style="display:none;">
            <input type="text" name="Child Full Name" placeholder="Child's Full Name" />
            <label class="small">Date of Birth (Child):</label>
            <input type="date" name="Child Date of Birth" />
            <label class="small">Upload Birth Certificate:</label>
            <input type="file" name="Birth Certificate" accept=".jpg,.jpeg,.png,.pdf" />
          </div>
        </div>
      </div>

      <button type="submit"><i class="fas fa-paper-plane"></i> Submit Request</button>
    </form>
  </div>

  <div class="section">
    <h2><i class="fas fa-route icon"></i>How to Setup MetaMask</h2>
    <ol>
      <li>Install MetaMask: <span class="mono">metamask.io</span></li>
      <li>Create Wallet â†’ Save secret recovery phrase</li>
      <li>Enable Sepolia test network in MetaMask</li>
      <li>Import your GBC token using the contract address below (after we confirm it)</li>
    </ol>
  </div>

  <div class="section">
    <h2><i class="fas fa-shield-alt icon"></i>Admin Panel (Sepolia)</h2>

    <div class="row" style="align-items:center;">
      <div class="col">
        <div class="pill"><i class="fa-solid fa-network-wired"></i> Network: <span id="netLabel" class="status warn">Not connected</span></div>
      </div>
      <div class="col">
        <div class="pill">
          <i class="fa-solid fa-file-contract"></i>
          Contract:
          <span id="contractLabel" class="mono"></span>
        </div>
      </div>
    </div>

    <!-- âœ… Phase 1 enhancements added as extra pills (keeps your UI intact) -->
    <div class="miniGrid">
      <div class="pill"><i class="fa-solid fa-id-card"></i> On-chain Admin: <span id="adminLabel" class="mono">â€”</span></div>
      <div class="pill"><i class="fa-solid fa-lock"></i> Admin Access: <span id="adminAccess" class="status warn">Not connected</span></div>
      <div class="pill"><i class="fa-solid fa-coins"></i> Token: <span id="tokenMeta" class="mono">â€”</span></div>
      <div class="pill"><i class="fa-solid fa-gift"></i> Entitlement Cap: <span id="capLabel" class="mono">â€”</span></div>

      <!-- âœ… NEW: Pause status (if contract supports paused()) -->
      <div class="pill"><i class="fa-solid fa-circle-pause"></i> Contract Status: <span id="pauseStatus" class="status warn">â€”</span></div>

      <!-- âœ… NEW: Treasury floor (if contract supports treasuryFloor()) -->
      <div class="pill"><i class="fa-solid fa-vault"></i> Treasury Floor: <span id="floorLabel" class="mono">â€”</span></div>
    </div>

    <p><strong>Connected Wallet:</strong> <span id="walletAddress">Not Connected</span></p>

    <div class="btnRow">
      <button id="connectBtn" onclick="connectWallet()"><i class="fas fa-link"></i> Connect MetaMask</button>
      <button id="switchBtn" onclick="switchToSepolia()" disabled>ðŸ§ª Switch to Sepolia</button>
    </div>

    <p class="balance">Wallet Balance: <span id="balance">0</span> <b>GBC</b></p>

    <div class="notice" id="adminSafetyNote" style="display:none;">
      <div class="pill"><i class="fa-solid fa-shield-halved"></i> Safety Lock</div>
      <p class="small" style="margin-top:10px;">
        Sending / Approving is <b>locked</b> unless your connected wallet matches the <b>on-chain admin()</b> address.
        If the contract is <b>Paused</b>, all actions are locked.
      </p>
    </div>

    <h3 style="margin:14px 0 6px 0;"><i class="fas fa-paper-plane icon"></i>Send Approved GBC</h3>
    <div class="row">
      <div class="col">
        <input type="text" id="sendAddress" placeholder="Recipient Wallet Address" />
      </div>
      <div class="col">
        <input type="number" id="sendAmount" placeholder="Amount to Send" />
      </div>
    </div>

    <button id="sendBtn" onclick="sendGBC()" disabled><i class="fas fa-check-circle"></i> Send Approved GBC</button>
    <p id="transactionStatus" style="margin-top:10px;"></p>

    <hr class="divider" />
    <h3 style="margin:14px 0 6px 0;"><i class="fas fa-user-shield icon"></i>Admin Tools (On-chain)</h3>
    <div class="row">
      <div class="col">
        <input type="text" id="approveUserAddr" placeholder="User wallet to approve (allow claim)" />
      </div>
      <div class="col">
        <select id="approveUserBool" style="width:100%; padding:11px 12px; margin:7px 0; border-radius:10px; border:1px solid #cdd7e3; font-size:15px;">
          <option value="true">Approve âœ…</option>
          <option value="false">Revoke â›”</option>
        </select>
      </div>
    </div>
    <button id="approveBtn" onclick="setApprovedUser()" disabled><i class="fas fa-check-circle"></i> Set Approved (Admin Only)</button>

    <hr class="divider" />
    <h3 style="margin:14px 0 6px 0;"><i class="fas fa-gift icon"></i>My Entitlement (On-chain)</h3>
    <div class="miniGrid">
      <div class="pill"><i class="fa-solid fa-user-check"></i> Approved? <span id="meApproved" class="mono">â€”</span></div>
      <div class="pill"><i class="fa-solid fa-flag-checkered"></i> Claimed? <span id="meClaimed" class="mono">â€”</span></div>
    </div>
    <button id="claimBtn" onclick="claimEntitlement()" disabled><i class="fas fa-gift"></i> Claim (If Approved)</button>
  </div>

  <div class="section">
    <h2><i class="fas fa-dollar-sign icon"></i>Sell Your GBC (P2P Offer)</h2>
    <p>You can offer to sell up to <strong>0.01125 GBC</strong> (90% of 0.0125 cap) to another user.</p>

    <div class="row">
      <div class="col">
        <input type="number" id="sellAmount" placeholder="Amount of GBC to Sell (Max: 0.01125)" step="0.0001" max="0.01125" oninput="enforceSellLimit(this)" />
      </div>
      <div class="col">
        <input type="text" id="buyerAddress" placeholder="Buyer Wallet Address" />
      </div>
    </div>

    <input type="text" id="sellPrice" placeholder="Price in USD (Optional)" />
    <button onclick="sellGBC()"><i class="fas fa-paper-plane"></i> Send Sell Offer</button>
    <p id="sellStatus" style="color: var(--ok); margin-top:10px;"></p>
  </div>

  <div class="section">
    <h2><i class="fas fa-inbox icon"></i>Buyer Inbox (Sell Offers)</h2>
    <p>Paste your wallet address to check if someone sent you an offer:</p>
    <input type="text" id="buyerLookup" placeholder="Your Wallet Address" />
    <button onclick="checkOffers()">Check Sell Offers</button>
    <div id="inboxResults" style="margin-top:10px;"></div>
  </div>

<script>
  // =========================================================
  // âœ… Phase 1 "Go-Live Safety" Enhancements (UI kept intact)
  // Added (safe + optional; works even if contract lacks these functions):
  // 1) paused() read + UI status + automatic action lock when paused
  // 2) treasuryFloor() read + UI display (optional)
  // 3) Stronger send preflight:
  //    - contract code exists
  //    - recipient != zero address
  //    - amount <= sender balance
  //    - clearer MetaMask / on-chain error messaging
  // =========================================================

  const SEPOLIA_CHAIN_ID_HEX = "0xaa36a7"; // 11155111
  const CONTRACT_ADDRESS = "0xa3181dFb7D3ED2D74955c2E48DaB1984B24947FD"; // <-- set to your deployed GBCEntitlement on Sepolia
  const FALLBACK_DECIMALS = 18;

  const ERC20_MIN_ABI = [
    {"inputs":[{"internalType":"address","name":"a","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
    {"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
    {"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
    {"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
    {"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
  ];

  const ENTITLEMENT_ABI = [
    {"inputs":[],"name":"admin","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
    {"inputs":[],"name":"entitlementCap","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
    {"inputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"bool","name":"allowed","type":"bool"}],"name":"setApproved","outputs":[],"stateMutability":"nonpayable","type":"function"},
    {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"approved","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
    {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"hasClaimed","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
    {"inputs":[],"name":"claim","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
    {"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"adminTransfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},

    // âœ… Optional Phase-1 safety (if your contract has them)
    {"inputs":[],"name":"paused","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
    {"inputs":[],"name":"treasuryFloor","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  ];

  let provider, signer, walletAddress;
  let tokenDecimals = FALLBACK_DECIMALS;
  let cachedAdmin = null;
  let cachedCap = null;

  // âœ… NEW Phase-1 state
  let cachedPaused = null;     // true/false/null (if not available)
  let cachedFloor = null;      // BigNumber/null

  const web3Notice = document.getElementById("web3Notice");
  const walletEl = document.getElementById("walletAddress");
  const balEl = document.getElementById("balance");
  const netLabel = document.getElementById("netLabel");
  const contractLabel = document.getElementById("contractLabel");
  const switchBtn = document.getElementById("switchBtn");
  const sendBtn = document.getElementById("sendBtn");
  const approveBtn = document.getElementById("approveBtn");
  const claimBtn = document.getElementById("claimBtn");
  const txStatus = document.getElementById("transactionStatus");

  const adminLabel = document.getElementById("adminLabel");
  const adminAccess = document.getElementById("adminAccess");
  const capLabel = document.getElementById("capLabel");
  const tokenMeta = document.getElementById("tokenMeta");
  const adminSafetyNote = document.getElementById("adminSafetyNote");
  const meApproved = document.getElementById("meApproved");
  const meClaimed = document.getElementById("meClaimed");

  // âœ… NEW UI refs
  const pauseStatusEl = document.getElementById("pauseStatus");
  const floorLabelEl = document.getElementById("floorLabel");

  contractLabel.textContent = CONTRACT_ADDRESS;
  contractLabel.title = CONTRACT_ADDRESS;

  function shortAddr(a){
    if (!a || a.length < 10) return a || "";
    return a.slice(0,6) + "..." + a.slice(-4);
  }

  function setNetStatus(kind, text){
    netLabel.className = "status " + kind;
    netLabel.textContent = text;
  }

  function setTxStatus(kind, text){
    txStatus.className = "status " + kind;
    txStatus.textContent = text;
  }

  function setPauseUI(pausedVal){
    // pausedVal can be true/false/null
    if (pausedVal === null){
      pauseStatusEl.className = "status warn";
      pauseStatusEl.textContent = "N/A";
      return;
    }
    if (pausedVal){
      pauseStatusEl.className = "status bad";
      pauseStatusEl.textContent = "PAUSED â›”";
    } else {
      pauseStatusEl.className = "status ok";
      pauseStatusEl.textContent = "LIVE âœ…";
    }
  }

  function hasWeb3(){
    return typeof window.ethereum !== "undefined";
  }

  function showWeb3HelpIfNeeded(){
    if (!hasWeb3()){
      web3Notice.style.display = "block";
    }
  }

  window.copyLink = async function(){
    const url = window.location.href;
    try{
      await navigator.clipboard.writeText(url);
      alert("Link copied! Now open MetaMask â†’ Browser â†’ paste â†’ open.");
    }catch(e){
      prompt("Copy this link:", url);
    }
  };

  window.openInMetaMask = function(){
    const clean = window.location.href.replace(/^https?:\/\//, "");
    const deep = "https://metamask.app.link/dapp/" + clean;
    window.location.href = deep;
  };

  async function getChainIdHex(){
    if (!hasWeb3()) return null;
    try{
      return await window.ethereum.request({ method: "eth_chainId" });
    }catch(e){
      return null;
    }
  }

  async function refreshNetworkUI(){
    const cid = await getChainIdHex();
    if (!cid){
      setNetStatus("warn", "Not connected");
      switchBtn.disabled = true;
      return;
    }
    if (cid.toLowerCase() === SEPOLIA_CHAIN_ID_HEX){
      setNetStatus("ok", "Sepolia");
      switchBtn.disabled = true;
    } else {
      setNetStatus("bad", "Wrong network");
      switchBtn.disabled = false;
    }
  }

  async function ensureContractCodeExists(){
    if (!provider) return false;
    try{
      const code = await provider.getCode(CONTRACT_ADDRESS);
      return (code && code !== "0x");
    }catch(_e){
      return false;
    }
  }

  function getReadContract(){
    if (!provider) throw new Error("Provider not ready");
    return new ethers.Contract(CONTRACT_ADDRESS, [...ERC20_MIN_ABI, ...ENTITLEMENT_ABI], provider);
  }

  function getWriteContract(){
    if (!signer) throw new Error("Connect MetaMask first");
    return new ethers.Contract(CONTRACT_ADDRESS, [...ERC20_MIN_ABI, ...ENTITLEMENT_ABI], signer);
  }

  async function loadTokenMeta(){
    try{
      if (!provider) return;
      const c = getReadContract();
      const [nm, sym, dec] = await Promise.all([
        c.name().catch(()=>null),
        c.symbol().catch(()=>null),
        c.decimals().catch(()=>null),
      ]);
      if (typeof dec === "number") tokenDecimals = dec;
      else if (dec && dec.toNumber) tokenDecimals = dec.toNumber();
      tokenMeta.textContent = `${nm || "Token"} (${sym || "â€”"}) â€¢ decimals ${tokenDecimals}`;
    }catch(_e){
      tokenDecimals = FALLBACK_DECIMALS;
      tokenMeta.textContent = "â€”";
    }
  }

  async function loadAdminAndCap(){
    try{
      if (!provider) return;
      const c = getReadContract();
      cachedAdmin = await c.admin();
      adminLabel.textContent = cachedAdmin ? shortAddr(cachedAdmin) : "â€”";
      cachedCap = await c.entitlementCap().catch(()=>null);
      capLabel.textContent = cachedCap ? (ethers.utils.formatUnits(cachedCap, tokenDecimals) + " GBC") : "â€”";
    }catch(_e){
      cachedAdmin = null;
      cachedCap = null;
      adminLabel.textContent = "â€”";
      capLabel.textContent = "â€”";
    }
  }

  // âœ… NEW: load paused + treasury floor safely
  async function loadSafetyState(){
    cachedPaused = null;
    cachedFloor = null;
    setPauseUI(null);
    floorLabelEl.textContent = "â€”";

    try{
      if (!provider) return;
      const c = getReadContract();

      // paused() optional
      const p = await c.paused().catch(()=>null);
      if (typeof p === "boolean") cachedPaused = p;
      else if (p !== null && p !== undefined) cachedPaused = !!p;
      setPauseUI(cachedPaused);

      // treasuryFloor() optional
      const floor = await c.treasuryFloor().catch(()=>null);
      cachedFloor = floor || null;
      if (cachedFloor){
        floorLabelEl.textContent = ethers.utils.formatUnits(cachedFloor, tokenDecimals) + " GBC";
      } else {
        floorLabelEl.textContent = "N/A";
      }
    }catch(_e){
      cachedPaused = null;
      cachedFloor = null;
      setPauseUI(null);
      floorLabelEl.textContent = "â€”";
    }
  }

  function isAdminWallet(){
    if (!walletAddress || !cachedAdmin) return false;
    return walletAddress.toLowerCase() === cachedAdmin.toLowerCase();
  }

  function onSepolia(){
    return (netLabel.textContent || "").toLowerCase().includes("sepolia");
  }

  function isPaused(){
    return cachedPaused === true;
  }

  function unlockActions(){
    const connected = !!signer && !!walletAddress;
    const sep = onSepolia();
    const adminOk = isAdminWallet();
    const pausedNow = isPaused();

    // Show safety note if:
    // - connected but not admin (for admin actions) OR
    // - wrong net OR
    // - paused
    adminSafetyNote.style.display = (connected && (!adminOk || !sep || pausedNow)) ? "block" : "none";

    // âœ… Phase 1 lock when paused
    if (pausedNow){
      sendBtn.disabled = true;
      approveBtn.disabled = true;
      claimBtn.disabled = true;

      adminAccess.className = "status bad";
      adminAccess.textContent = "Paused â›”";
      return;
    }

    // Keep your features exactly the same, just add guards:
    sendBtn.disabled = !(connected && sep && adminOk);
    approveBtn.disabled = !(connected && sep && adminOk);
    claimBtn.disabled = !(connected && sep);

    if (!connected) {
      adminAccess.className = "status warn";
      adminAccess.textContent = "Not connected";
    } else if (!sep) {
      adminAccess.className = "status bad";
      adminAccess.textContent = "Wrong network";
    } else if (adminOk) {
      adminAccess.className = "status ok";
      adminAccess.textContent = "Admin âœ…";
    } else {
      adminAccess.className = "status bad";
      adminAccess.textContent = "Not admin â›”";
    }
  }

  window.switchToSepolia = async function(){
    if (!hasWeb3()){
      alert("MetaMask not detected. Open this site inside MetaMask Browser.");
      return;
    }
    try{
      await window.ethereum.request({
        method: "wallet_switchEthereumChain",
        params: [{ chainId: SEPOLIA_CHAIN_ID_HEX }]
      });
      await refreshAll();
    }catch(err){
      if (err && err.code === 4902){
        try{
          await window.ethereum.request({
            method: "wallet_addEthereumChain",
            params: [{
              chainId: SEPOLIA_CHAIN_ID_HEX,
              chainName: "Sepolia",
              nativeCurrency: { name: "SepoliaETH", symbol: "ETH", decimals: 18 },
              rpcUrls: ["https://rpc.sepolia.org"],
              blockExplorerUrls: ["https://sepolia.etherscan.io"]
            }]
          });
          await refreshAll();
        }catch(e2){
          alert("Could not add Sepolia network. Please add it manually in MetaMask.");
        }
      } else {
        alert("Network switch cancelled or failed.");
      }
    }
  };

  window.connectWallet = async function(){
    showWeb3HelpIfNeeded();
    if (!hasWeb3()){
      alert("No Web3 detected. On Android, open this site inside MetaMask Browser.");
      return;
    }
    try{
      provider = new ethers.providers.Web3Provider(window.ethereum, "any");
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      walletAddress = await signer.getAddress();
      walletEl.textContent = shortAddr(walletAddress);

      // Event listeners
      window.ethereum.on?.("accountsChanged", async () => {
        try{
          signer = provider.getSigner();
          walletAddress = await signer.getAddress();
          walletEl.textContent = shortAddr(walletAddress);
          await refreshAll();
        }catch(e){}
      });
      window.ethereum.on?.("chainChanged", async () => {
        await refreshAll();
      });

      await refreshAll();

      const cid = await getChainIdHex();
      if (cid && cid.toLowerCase() !== SEPOLIA_CHAIN_ID_HEX){
        setTxStatus("warn", "Please switch to Sepolia to use this wallet.");
        switchBtn.disabled = false;
      } else {
        setTxStatus("ok", "Connected. Ready.");
      }
    }catch(err){
      console.error(err);
      alert("Connection failed or cancelled.");
    }
  };

  async function getBalance(){
    if (!signer || !walletAddress){
      balEl.textContent = "0";
      return;
    }
    try{
      const cid = await getChainIdHex();
      if (!cid || cid.toLowerCase() !== SEPOLIA_CHAIN_ID_HEX){
        balEl.textContent = "â€”";
        return;
      }
      const c = getWriteContract();
      const balance = await c.balanceOf(walletAddress);
      balEl.textContent = ethers.utils.formatUnits(balance, tokenDecimals);
    }catch(err){
      console.error("Error reading balance:", err);
      balEl.textContent = "Error";
    }
  }

  async function refreshMyEntitlementStatus(){
    if (!provider || !walletAddress){
      meApproved.textContent = "â€”";
      meClaimed.textContent = "â€”";
      return;
    }
    try{
      const cid = await getChainIdHex();
      if (!cid || cid.toLowerCase() !== SEPOLIA_CHAIN_ID_HEX){
        meApproved.textContent = "â€”";
        meClaimed.textContent = "â€”";
        return;
      }
      const c = getReadContract();
      const [ap, cl] = await Promise.all([
        c.approved(walletAddress).catch(()=>null),
        c.hasClaimed(walletAddress).catch(()=>null)
      ]);
      meApproved.textContent = (ap === null) ? "N/A" : (ap ? "YES âœ…" : "NO â›”");
      meClaimed.textContent = (cl === null) ? "N/A" : (cl ? "YES âœ…" : "NO");
    }catch(_e){
      meApproved.textContent = "Error";
      meClaimed.textContent = "Error";
    }
  }

  async function refreshAll(){
    await refreshNetworkUI();

    if (provider) {
      const okCode = await ensureContractCodeExists();
      if (!okCode) {
        setTxStatus("bad", "Contract address has no code on this network. Check CONTRACT_ADDRESS / network.");
      }
    }

    await loadTokenMeta();
    await loadAdminAndCap();
    await loadSafetyState();      // âœ… NEW
    await getBalance();
    await refreshMyEntitlementStatus();
    unlockActions();
  }

  // âœ… Better error message extraction
  function extractEthersError(err){
    const raw =
      err?.error?.message ||
      err?.data?.message ||
      err?.reason ||
      err?.message ||
      "Transaction failed or cancelled.";
    // keep it short for UI
    return String(raw).slice(0, 220);
  }

  // âœ… Preflight send checks
  async function sendPreflight(recipient, amountStr){
    if (!ethers.utils.isAddress(recipient)) throw new Error("Recipient address is not valid.");
    if (recipient.toLowerCase() === "0x0000000000000000000000000000000000000000") throw new Error("Recipient cannot be the zero address.");
    if (!amountStr || Number(amountStr) <= 0) throw new Error("Enter a valid amount.");

    // If paused, block
    if (isPaused()) throw new Error("Contract is paused.");

    // Optional: ensure enough balance
    const c = getWriteContract();
    const bal = await c.balanceOf(walletAddress);
    const valueWei = ethers.utils.parseUnits(String(amountStr), tokenDecimals);
    if (valueWei.gt(bal)) throw new Error("Insufficient GBC balance for this send.");

    return valueWei;
  }

  window.sendGBC = async function(){
    if (!signer){
      alert("Connect MetaMask first.");
      return;
    }
    const cid = await getChainIdHex();
    if (!cid || cid.toLowerCase() !== SEPOLIA_CHAIN_ID_HEX){
      alert("Please switch to Sepolia first.");
      return;
    }

    await loadAdminAndCap();
    await loadSafetyState();
    unlockActions();

    if (isPaused()){
      alert("Contract is paused. Sending is locked.");
      return;
    }

    if (!isAdminWallet()){
      alert("Safety lock: connected wallet is not the on-chain admin().");
      unlockActions();
      return;
    }

    const recipient = document.getElementById("sendAddress").value.trim();
    const amount = document.getElementById("sendAmount").value;

    try{
      setTxStatus("warn", "Preflight checksâ€¦");
      const valueWei = await sendPreflight(recipient, amount);

      setTxStatus("warn", "Transaction pendingâ€¦ please confirm in MetaMask.");
      const c = getWriteContract();

      // Prefer adminTransfer (your contract). Fallback to transfer.
      let tx;
      try{
        tx = await c.adminTransfer(recipient, valueWei);
      }catch(_e){
        tx = await c.transfer(recipient, valueWei);
      }

      setTxStatus("warn", "Pendingâ€¦ waiting for confirmation on-chain.");
      await tx.wait();

      setTxStatus("ok", "Transaction successful âœ…");
      await getBalance();
    }catch(err){
      console.error(err);
      setTxStatus("bad", extractEthersError(err));
    }
  };

  window.setApprovedUser = async function(){
    if (!signer){
      alert("Connect MetaMask first.");
      return;
    }
    const cid = await getChainIdHex();
    if (!cid || cid.toLowerCase() !== SEPOLIA_CHAIN_ID_HEX){
      alert("Please switch to Sepolia first.");
      return;
    }

    await loadAdminAndCap();
    await loadSafetyState();
    unlockActions();

    if (isPaused()){
      alert("Contract is paused. Approvals are locked.");
      return;
    }

    if (!isAdminWallet()){
      alert("Safety lock: connected wallet is not the on-chain admin().");
      unlockActions();
      return;
    }

    const user = document.getElementById("approveUserAddr").value.trim();
    const allowed = document.getElementById("approveUserBool").value === "true";

    if (!ethers.utils.isAddress(user)){
      alert("User address is not valid.");
      return;
    }

    try{
      setTxStatus("warn", "Approval pendingâ€¦ confirm in MetaMask.");
      const c = getWriteContract();
      const tx = await c.setApproved(user, allowed);
      setTxStatus("warn", "Pendingâ€¦ waiting confirmation.");
      await tx.wait();
      setTxStatus("ok", allowed ? "Approved âœ… (user can claim)" : "Revoked â›” (user cannot claim)");
      await refreshMyEntitlementStatus();
    }catch(err){
      console.error(err);
      setTxStatus("bad", extractEthersError(err));
    }
  };

  window.claimEntitlement = async function(){
    if (!signer){
      alert("Connect MetaMask first.");
      return;
    }
    const cid = await getChainIdHex();
    if (!cid || cid.toLowerCase() !== SEPOLIA_CHAIN_ID_HEX){
      alert("Please switch to Sepolia first.");
      return;
    }

    await loadSafetyState();
    unlockActions();

    if (isPaused()){
      alert("Contract is paused. Claims are locked.");
      return;
    }

    try{
      setTxStatus("warn", "Claim pendingâ€¦ confirm in MetaMask.");
      const c = getWriteContract();
      const tx = await c.claim();
      setTxStatus("warn", "Pendingâ€¦ waiting confirmation.");
      await tx.wait();
      setTxStatus("ok", "Claim successful âœ…");
      await getBalance();
      await refreshMyEntitlementStatus();
    }catch(err){
      console.error(err);
      setTxStatus("bad", extractEthersError(err));
    }
  };

  // Minor fields + P2P inbox (demo) - unchanged
  window.toggleMinorFields = function(){
    const checkbox = document.getElementById("claimingMinor");
    const section = document.getElementById("minorSection");
    section.style.display = checkbox.checked ? "block" : "none";
  };

  window.enforceSellLimit = function(input){
    const maxSell = 0.01125;
    if (parseFloat(input.value) > maxSell) input.value = maxSell;
  };

  let sellOffers = [];

  window.sellGBC = function(){
    const amount = parseFloat(document.getElementById("sellAmount").value);
    const buyer = document.getElementById("buyerAddress").value;
    const price = document.getElementById("sellPrice").value;

    if (!amount || amount <= 0 || amount > 0.01125) {
      alert("Amount must be between 0.0001 and 0.01125 GBC.");
      return;
    }
    if (!buyer || !buyer.trim()) {
      alert("Please enter the buyer wallet address.");
      return;
    }

    sellOffers.push({ amount, buyer: buyer.trim(), price: price || "N/A" });
    document.getElementById("sellStatus").innerText = `Offer saved locally for ${buyer.trim()} (demo).`;
  };

  window.checkOffers = function(){
    const buyerLookup = document.getElementById("buyerLookup").value.trim();
    const resultBox = document.getElementById("inboxResults");
    const results = sellOffers.filter(o => o.buyer === buyerLookup);

    if (results.length === 0) {
      resultBox.innerHTML = "<p>No offers found for this wallet.</p>";
    } else {
      let html = "<ul>";
      results.forEach(o => { html += `<li>${o.amount} GBC offered at $${o.price}</li>`; });
      html += "</ul>";
      resultBox.innerHTML = html;
    }
  };

  (function init(){
    showWeb3HelpIfNeeded();
    refreshNetworkUI();
    contractLabel.textContent = CONTRACT_ADDRESS;
    setPauseUI(null);
    floorLabelEl.textContent = "â€”";
    unlockActions();
  })();
</script>

</body>
</html>
